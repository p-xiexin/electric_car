/**
  ******************************************************************************
  * @file    bsp_bsp_adc.c
  * @author  fire
  * @version V1.0
  * @date    2015-xx-xx
  * @brief   adc驱动
  ******************************************************************************
  * @attention
  *
  * 实验平台:野火  STM32 F429 开发板  
  * 论坛    :http://www.firebbs.cn
  * 淘宝    :https://fire-stm32.taobao.com
  *
  ******************************************************************************
  */ 

#include "adc.h"
extern q15_t Mic1_Real[1024];
extern q15_t Mic2_Real[1024];
extern int err;

double OUT[2048];
double BASE;
double BASE_sum;
__IO uint16_t ADC_ConvertedValue[RHEOSTAT_NOFCHANEL*NUM_OF_CYCLE]={0};
double ADC1_TURE[NUM_OF_CYCLE]={0};
double ADC2_TURE[NUM_OF_CYCLE]={0};
double ADC1_OUT[NUM_OF_CYCLE]={0};
double ADC2_OUT[NUM_OF_CYCLE]={0};
//double b[51] = {0.001511915166592, 0.002597258779883,-0.004107022219828,-0.008518514044466,
//   0.007011162091414,  0.01628509474337,-0.008075595942678, -0.01979519709948,
//   0.005463974720331,  0.01151064285485,0.0004847018232652,  0.01070159302377,
//  -0.006729081792953, -0.03705747465855, 0.009113262589401,  0.04660396579669,
//  -0.005433383850355, -0.01798489709526,-0.002447515770811, -0.05480503538626,
//   0.009367069666068,   0.1528090260093, -0.01038048842237,  -0.2376494740246,
//   0.004472436616902,    0.271220640296, 0.004472436616902,  -0.2376494740246,
//   -0.01038048842237,   0.1528090260093, 0.009367069666068, -0.05480503538626,
//  -0.002447515770811, -0.01798489709526,-0.005433383850355,  0.04660396579669,
//   0.009113262589401, -0.03705747465855,-0.006729081792953,  0.01070159302377,
//  0.0004847018232652,  0.01151064285485, 0.005463974720331, -0.01979519709948,
//  -0.008075595942678,  0.01628509474337, 0.007011162091414,-0.008518514044466,
//  -0.004107022219828, 0.002597258779883, 0.001511915166592};
//double b[507] = {                                  164
//  8.210013110524e-05,4.969399500514e-05,6.286737907026e-05,7.678225369131e-05,
//  9.095320316602e-05,0.0001048139093013, 0.000117676993211,0.0001287964955687,
//  0.0001373453276573,0.0001424911855106,0.0001433812425007,0.0001392186880829,
//  0.0001292486768774,0.0001128445188471,8.950218671289e-05,5.893666420418e-05,
//  2.106776562891e-05,-2.390429436012e-05,-7.553639364951e-05,-0.0001330730726586,
//  -0.0001954795222699,-0.0002613732464131,-0.0003291023139999,-0.000396734506544,
//  -0.0004621764742765,-0.0005231336043645,-0.0005772064650114,-0.0006219035691214,
//  -0.0006548627051043,-0.000673838601885,-0.0006767892216756,-0.0006618788346081,
//  -0.0006278822787515,-0.0005739206134771,-0.0004995589560817,-0.0004052389920981,
//  -0.0002917473583538,-0.0001607657389937,-1.450109969601e-05,0.0001441203980402,
//  0.0003116216341273,0.0004839629417218,0.0006566804044817,0.0008249626354355,
//  0.0009838140006018, 0.001128178230713, 0.001253105951125, 0.001353903184899,
//   0.001426303964604, 0.001466632464806, 0.001471948570096, 0.001440176185838,
//   0.001370208975617,   0.0012620105798, 0.001116663974498,0.0009363905301852,
//  0.0007245152351999, 0.000485446824727,0.0002245779567955,-5.184286997307e-05,
//  -0.0003369020788606,-0.0006231542164245,-0.0009028617716484,-0.001168235357259,
//  -0.001411680051599,-0.001625964201198,-0.001804593130705,-0.001941904083572,
//  -0.002033323894873,-0.002075569599351,-0.002066703322547,-0.002006320415261,
//  -0.001895508731855,-0.001736908617701,-0.001534615758768,-0.001294103848272,
//   -0.00102204614175,-0.0007261302542721,-0.0004148112042823,-9.705476424989e-05,
//  0.0002179641925527,0.0005211660880484,0.0008038721116974, 0.001058096097561,
//   0.001276820528533, 0.001454253678397, 0.001586030097521, 0.001669364779252,
//   0.001703155534901, 0.001688040045044, 0.001626360659635, 0.001522084232845,
//   0.001380658455396, 0.001208823080801, 0.001014328161197,0.0008056627833827,
//  0.0005917265921928,0.0003814710980922,0.0001835367795452,5.949686839594e-06,
//  -0.0001442758007978,-0.0002613616148116,-0.0003410696340254,-0.0003808714974939,
//  -0.0003800742493387,-0.0003398930252232,-0.0002634157653537,-0.0001555252686893,
//  -2.271560911604e-05,0.0001271421839552,0.0002851038751134,0.0004415031043052,
//  0.0005863501354856,0.0007097523323482,0.0008023399002109,0.0008556861828426,
//  0.0008627056867389,0.0008180162960642,0.0007182288992293,0.0005621848423603,
//  0.0003511039882732, 8.86460998923e-05,-0.0002191336800615,-0.0005639030126455,
//  -0.0009352838704367,-0.001321168278889,-0.001708117796173,-0.002081805744756,
//  -0.002427549458532,-0.002730844640396,-0.002977921686819, -0.00315630019044,
//  -0.003255313373098,-0.003266557201152,-0.003184331526382,-0.003005908761114,
//  -0.002731786381769,-0.002365757578666,-0.001914911993279, -0.00138948551496,
//  -0.0008026005887956,-0.0001698869224639, 0.000490991663506,  0.00116091038297,
//   0.001819914486141,  0.00244790775987, 0.003025349728122, 0.003533964679979,
//   0.003957409482893, 0.004281890799443, 0.004496693488304, 0.004594625200984,
//   0.004572315914719, 0.004430398461745, 0.004173533831191, 0.003810301663366,
//   0.003352919080181, 0.002816838821091, 0.002220206993233, 0.001583218557196,
//  0.0009273693916975,0.0002746725321908,-0.000353190546586,-0.0009356924523412,
//  -0.001454261714558,-0.001893023059241,-0.002239444141791,-0.002484846612797,
//  -0.002624806473838,-0.002659341915744,-0.002592985459558,-0.002434617065785,
//  -0.002197164263078,-0.001897096272602,-0.001553786846571,-0.001188717738162,
//  -0.000824597941788,-0.0004843850848224,-0.0001902886319376,3.725296375588e-05,
//   0.000180526358058,0.0002254406698992,0.0001622938805571,-1.360017090085e-05,
//  -0.0003014875749014,-0.0006949313251126,-0.001181813554477,-0.001744549946744,
//  -0.002360556134876,-0.003002913320182,-0.003641263759961,-0.004242864669705,
//  -0.004773802887835,-0.005200301057024,-0.005490103639265,-0.005613843864106,
//  -0.005546400331955,-0.005268132923704,-0.004765991336077,-0.004034424296193,
//  -0.003076060387182, -0.00190211189048,-0.0005325051865515, 0.001004332575991,
//   0.002671958937929, 0.004426755669546, 0.006219025573799, 0.007994386033972,
//   0.009695361226677,  0.01126318162187,  0.01263968668572,  0.01376931383443,
//    0.01460105573003,  0.01509038330035,  0.01520099966417,  0.01490641699843,
//    0.01419125220223,  0.01305222867957,  0.01149879685126, 0.009553389551537,
//   0.007251242836355, 0.004639822994587, 0.001777815986356,-0.001266245967364,
//  -0.004415739908318,-0.007587995629972, -0.01069661004414, -0.01365392618104,
//   -0.01637364465565,  -0.0187734345849, -0.02077752180217, -0.02231910945679,
//   -0.02334260606876,  -0.0238055441119, -0.02368015018329, -0.02295449064651,
//   -0.02163317874212, -0.01973756386727, -0.01730545240049, -0.01439029552139,
//   -0.01105992497432,-0.007394808918622, -0.00348593016681, 0.000567695633497,
//   0.004661754873332, 0.008689579849498,  0.01254516114656,  0.01612620237612,
//     0.0193370569011,  0.02209151453521,  0.02431530210967,  0.02594826643622,
//    0.02694612707227,  0.02728178920383,  0.02694612707227,  0.02594826643622,
//    0.02431530210967,  0.02209151453521,   0.0193370569011,  0.01612620237612,
//    0.01254516114656, 0.008689579849498, 0.004661754873332, 0.000567695633497,
//   -0.00348593016681,-0.007394808918622, -0.01105992497432, -0.01439029552139,
//   -0.01730545240049, -0.01973756386727, -0.02163317874212, -0.02295449064651,
//   -0.02368015018329,  -0.0238055441119, -0.02334260606876, -0.02231910945679,
//   -0.02077752180217,  -0.0187734345849, -0.01637364465565, -0.01365392618104,
//   -0.01069661004414,-0.007587995629972,-0.004415739908318,-0.001266245967364,
//   0.001777815986356, 0.004639822994587, 0.007251242836355, 0.009553389551537,
//    0.01149879685126,  0.01305222867957,  0.01419125220223,  0.01490641699843,
//    0.01520099966417,  0.01509038330035,  0.01460105573003,  0.01376931383443,
//    0.01263968668572,  0.01126318162187, 0.009695361226677, 0.007994386033972,
//   0.006219025573799, 0.004426755669546, 0.002671958937929, 0.001004332575991,
//  -0.0005325051865515, -0.00190211189048,-0.003076060387182,-0.004034424296193,
//  -0.004765991336077,-0.005268132923704,-0.005546400331955,-0.005613843864106,
//  -0.005490103639265,-0.005200301057024,-0.004773802887835,-0.004242864669705,
//  -0.003641263759961,-0.003002913320182,-0.002360556134876,-0.001744549946744,
//  -0.001181813554477,-0.0006949313251126,-0.0003014875749014,-1.360017090085e-05,
//  0.0001622938805571,0.0002254406698992, 0.000180526358058,3.725296375588e-05,
//  -0.0001902886319376,-0.0004843850848224,-0.000824597941788,-0.001188717738162,
//  -0.001553786846571,-0.001897096272602,-0.002197164263078,-0.002434617065785,
//  -0.002592985459558,-0.002659341915744,-0.002624806473838,-0.002484846612797,
//  -0.002239444141791,-0.001893023059241,-0.001454261714558,-0.0009356924523412,
//  -0.000353190546586,0.0002746725321908,0.0009273693916975, 0.001583218557196,
//   0.002220206993233, 0.002816838821091, 0.003352919080181, 0.003810301663366,
//   0.004173533831191, 0.004430398461745, 0.004572315914719, 0.004594625200984,
//   0.004496693488304, 0.004281890799443, 0.003957409482893, 0.003533964679979,
//   0.003025349728122,  0.00244790775987, 0.001819914486141,  0.00116091038297,
//   0.000490991663506,-0.0001698869224639,-0.0008026005887956, -0.00138948551496,
//  -0.001914911993279,-0.002365757578666,-0.002731786381769,-0.003005908761114,
//  -0.003184331526382,-0.003266557201152,-0.003255313373098, -0.00315630019044,
//  -0.002977921686819,-0.002730844640396,-0.002427549458532,-0.002081805744756,
//  -0.001708117796173,-0.001321168278889,-0.0009352838704367,-0.0005639030126455,
//  -0.0002191336800615, 8.86460998923e-05,0.0003511039882732,0.0005621848423603,
//  0.0007182288992293,0.0008180162960642,0.0008627056867389,0.0008556861828426,
//  0.0008023399002109,0.0007097523323482,0.0005863501354856,0.0004415031043052,
//  0.0002851038751134,0.0001271421839552,-2.271560911604e-05,-0.0001555252686893,
//  -0.0002634157653537,-0.0003398930252232,-0.0003800742493387,-0.0003808714974939,
//  -0.0003410696340254,-0.0002613616148116,-0.0001442758007978,5.949686839594e-06,
//  0.0001835367795452,0.0003814710980922,0.0005917265921928,0.0008056627833827,
//   0.001014328161197, 0.001208823080801, 0.001380658455396, 0.001522084232845,
//   0.001626360659635, 0.001688040045044, 0.001703155534901, 0.001669364779252,
//   0.001586030097521, 0.001454253678397, 0.001276820528533, 0.001058096097561,
//  0.0008038721116974,0.0005211660880484,0.0002179641925527,-9.705476424989e-05,
//  -0.0004148112042823,-0.0007261302542721, -0.00102204614175,-0.001294103848272,
//  -0.001534615758768,-0.001736908617701,-0.001895508731855,-0.002006320415261,
//  -0.002066703322547,-0.002075569599351,-0.002033323894873,-0.001941904083572,
//  -0.001804593130705,-0.001625964201198,-0.001411680051599,-0.001168235357259,
//  -0.0009028617716484,-0.0006231542164245,-0.0003369020788606,-5.184286997307e-05,
//  0.0002245779567955, 0.000485446824727,0.0007245152351999,0.0009363905301852,
//   0.001116663974498,   0.0012620105798, 0.001370208975617, 0.001440176185838,
//   0.001471948570096, 0.001466632464806, 0.001426303964604, 0.001353903184899,
//   0.001253105951125, 0.001128178230713,0.0009838140006018,0.0008249626354355,
//  0.0006566804044817,0.0004839629417218,0.0003116216341273,0.0001441203980402,
//  -1.450109969601e-05,-0.0001607657389937,-0.0002917473583538,-0.0004052389920981,
//  -0.0004995589560817,-0.0005739206134771,-0.0006278822787515,-0.0006618788346081,
//  -0.0006767892216756,-0.000673838601885,-0.0006548627051043,-0.0006219035691214,
//  -0.0005772064650114,-0.0005231336043645,-0.0004621764742765,-0.000396734506544,
//  -0.0003291023139999,-0.0002613732464131,-0.0001954795222699,-0.0001330730726586,
//  -7.553639364951e-05,-2.390429436012e-05,2.106776562891e-05,5.893666420418e-05,
//  8.950218671289e-05,0.0001128445188471,0.0001292486768774,0.0001392186880829,
//  0.0001433812425007,0.0001424911855106,0.0001373453276573,0.0001287964955687,
//   0.000117676993211,0.0001048139093013,9.095320316602e-05,7.678225369131e-05,
//  6.286737907026e-05,4.969399500514e-05,8.210013110524e-05
//};
//double b[101] = {                          -187.5
//  -0.0009497784528727,-0.0006853340305122,-0.0003894413690367,-4.688727225519e-05,
//  0.0003579177029088,0.0008387126429185, 0.001405063286151, 0.002060127724555,
//   0.002798701049627, 0.003605721073219, 0.004455395840448, 0.005311079835658,
//   0.006125981311871, 0.006844730569075, 0.007405781415969, 0.007744559066063,
//   0.007797211159014,   0.0075047682633, 0.006817479647909, 0.005699062354883,
//   0.004130589003479, 0.002113743778246,-0.0003268028276882,-0.003142112304183,
//  -0.006258948707915,-0.009581095971349, -0.01299204269948, -0.01635897680181,
//   -0.01953795366883, -0.02238002741953, -0.02473806957297, -0.02647394748352,
//   -0.02746569951389, -0.02761432780114, -0.02684983413298, -0.02513615025078,
//   -0.02247465996071, -0.01890607469743, -0.01451050347669,-0.009405648391973,
//  -0.003743153143766, 0.002296770714019, 0.008512222460388,  0.01468769556469,
//    0.02060299704331,  0.02604258422809,  0.03080487193686,  0.03471105792971,
//     0.0376130332757,  0.03939998604077,  0.04000336944454,  0.03939998604077,
//     0.0376130332757,  0.03471105792971,  0.03080487193686,  0.02604258422809,
//    0.02060299704331,  0.01468769556469, 0.008512222460388, 0.002296770714019,
//  -0.003743153143766,-0.009405648391973, -0.01451050347669, -0.01890607469743,
//   -0.02247465996071, -0.02513615025078, -0.02684983413298, -0.02761432780114,
//   -0.02746569951389, -0.02647394748352, -0.02473806957297, -0.02238002741953,
//   -0.01953795366883, -0.01635897680181, -0.01299204269948,-0.009581095971349,
//  -0.006258948707915,-0.003142112304183,-0.0003268028276882, 0.002113743778246,
//   0.004130589003479, 0.005699062354883, 0.006817479647909,   0.0075047682633,
//   0.007797211159014, 0.007744559066063, 0.007405781415969, 0.006844730569075,
//   0.006125981311871, 0.005311079835658, 0.004455395840448, 0.003605721073219,
//   0.002798701049627, 0.002060127724555, 0.001405063286151,0.0008387126429185,
//  0.0003579177029088,-4.688727225519e-05,-0.0003894413690367,-0.0006853340305122,
//  -0.0009497784528727
//};

double b[101] = {
                  0.0004225156946431, 0.001630055532417, 0.002976037791945, 0.004424569325163,
   0.005932209600038, 0.007449132253767, 0.008920611803947,   0.0102887933773,
    0.01149469017605,  0.01248034196405,  0.01319105863701,  0.01357766638671,
    0.01359867042862,  0.01322224797316,   0.0124279881984,  0.01120830240973,
   0.009569437198303, 0.007532035953878, 0.005131209143196, 0.002416090817867,
  -0.000551122741174,-0.003696637177779, -0.00693699279656, -0.01018141325476,
   -0.01333450064205, -0.01629919258887, -0.01897988501774, -0.02128561541148,
   -0.02313319642086, -0.02445018854199, -0.02517760358299, -0.02527223767794,
   -0.02470854350704, -0.02347996580696, -0.02159968172693, -0.01910070750366,
   -0.01603535458935, -0.01247404099346,-0.008503486366994,-0.004224341426228,
  0.0002516771409503, 0.004805056894295, 0.009312060339674,  0.01364847978989,
    0.01769345244615,  0.02133320849214,  0.02446462623752,   0.0269984740882,
     0.0288622291736,  0.03000237648201,  0.03038610984854,  0.03000237648201,
     0.0288622291736,   0.0269984740882,  0.02446462623752,  0.02133320849214,
    0.01769345244615,  0.01364847978989, 0.009312060339674, 0.004805056894295,
  0.0002516771409503,-0.004224341426228,-0.008503486366994, -0.01247404099346,
   -0.01603535458935, -0.01910070750366, -0.02159968172693, -0.02347996580696,
   -0.02470854350704, -0.02527223767794, -0.02517760358299, -0.02445018854199,
   -0.02313319642086, -0.02128561541148, -0.01897988501774, -0.01629919258887,
   -0.01333450064205, -0.01018141325476, -0.00693699279656,-0.003696637177779,
  -0.000551122741174, 0.002416090817867, 0.005131209143196, 0.007532035953878,
   0.009569437198303,  0.01120830240973,   0.0124279881984,  0.01322224797316,
    0.01359867042862,  0.01357766638671,  0.01319105863701,  0.01248034196405,
    0.01149469017605,   0.0102887933773, 0.008920611803947, 0.007449132253767,
   0.005932209600038, 0.004424569325163, 0.002976037791945, 0.001630055532417,
  0.0004225156946431
};
static void Rheostat_ADC_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;	
	/*=====================通道10======================*/	
	// 使能 GPIO 时钟
	RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_GPIO_CLK1,ENABLE);		
	// 配置 IO
  GPIO_InitStructure.GPIO_Pin = RHEOSTAT_ADC_GPIO_PIN1;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
  //不上拉不下拉	
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
	GPIO_Init(RHEOSTAT_ADC_GPIO_PORT1, &GPIO_InitStructure);

	/*=====================通道11======================*/
	// 使能 GPIO 时钟
	RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_GPIO_CLK2,ENABLE);		
	// 配置 IO
  GPIO_InitStructure.GPIO_Pin = RHEOSTAT_ADC_GPIO_PIN2;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
  //不上拉不下拉	
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
	GPIO_Init(RHEOSTAT_ADC_GPIO_PORT2, &GPIO_InitStructure);	

	/*=====================通道12=======================*/
	// 使能 GPIO 时钟
	RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_GPIO_CLK3,ENABLE);		
	// 配置 IO
  GPIO_InitStructure.GPIO_Pin = RHEOSTAT_ADC_GPIO_PIN3;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
  //不上拉不下拉	
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
	GPIO_Init(RHEOSTAT_ADC_GPIO_PORT3, &GPIO_InitStructure);
	
	/*=====================通道13=======================*/
	// 使能 GPIO 时钟
	RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_GPIO_CLK4,ENABLE);		
	// 配置 IO
  GPIO_InitStructure.GPIO_Pin = RHEOSTAT_ADC_GPIO_PIN4;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
  //不上拉不下拉	
  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
	GPIO_Init(RHEOSTAT_ADC_GPIO_PORT4, &GPIO_InitStructure);
	
//	/*=====================通道14=======================*/
//	// 使能 GPIO 时钟
//	RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_GPIO_CLK5,ENABLE);		
//	// 配置 IO
//  GPIO_InitStructure.GPIO_Pin = RHEOSTAT_ADC_GPIO_PIN5;
//	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
//  //不上拉不下拉	
//  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
//	GPIO_Init(RHEOSTAT_ADC_GPIO_PORT5, &GPIO_InitStructure);
//	
//	/*=====================通道15=======================*/
//	// 使能 GPIO 时钟
//	RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_GPIO_CLK6,ENABLE);		
//	// 配置 IO
//  GPIO_InitStructure.GPIO_Pin = RHEOSTAT_ADC_GPIO_PIN6;
//	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
//  //不上拉不下拉	
//  GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
//	GPIO_Init(RHEOSTAT_ADC_GPIO_PORT6, &GPIO_InitStructure);
}

static void Rheostat_ADC_Mode_Config(void)
{
	
	NVIC_InitTypeDef NVIC_InitStructure; 

	DMA_InitTypeDef DMA_InitStructure;
	ADC_InitTypeDef ADC_InitStructure;
  ADC_CommonInitTypeDef ADC_CommonInitStructure;
	
  // ------------------DMA Init 结构体参数 初始化--------------------------
  // ADC1使用DMA2，数据流0，通道0，这个是手册固定死的
  // 开启DMA时钟
  RCC_AHB1PeriphClockCmd(RHEOSTAT_ADC_DMA_CLK, ENABLE); 
	// 外设基址为：ADC 数据寄存器地址
	DMA_InitStructure.DMA_PeripheralBaseAddr = RHEOSTAT_ADC_DR_ADDR;	
  // 存储器地址，实际上就是一个内部SRAM的变量	
	DMA_InitStructure.DMA_Memory0BaseAddr = (u32)ADC_ConvertedValue;  
  // 数据传输方向为外设到存储器	
	DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralToMemory;	
	// 缓冲区大小为，指一次传输的数据量
	DMA_InitStructure.DMA_BufferSize = RHEOSTAT_NOFCHANEL*NUM_OF_CYCLE;	
	// 外设寄存器只有一个，地址不用递增
	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;
  // 存储器地址固定
	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable; 
  // // 外设数据大小为半字，即两个字节 
	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord; 
  //	存储器数据大小也为半字，跟外设数据大小相同
	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;	
	// 循环传输模式
	DMA_InitStructure.DMA_Mode = DMA_Mode_Circular;
  // DMA 传输通道优先级为高，当使用一个DMA通道时，优先级设置不影响
	DMA_InitStructure.DMA_Priority = DMA_Priority_High;
  // 禁止DMA FIFO	，使用直连模式
  DMA_InitStructure.DMA_FIFOMode = DMA_FIFOMode_Disable;  
  // FIFO 大小，FIFO模式禁止时，这个不用配置	
  DMA_InitStructure.DMA_FIFOThreshold = DMA_FIFOThreshold_HalfFull;
  DMA_InitStructure.DMA_MemoryBurst = DMA_MemoryBurst_Single;
  DMA_InitStructure.DMA_PeripheralBurst = DMA_PeripheralBurst_Single;  
	// 选择 DMA 通道，通道存在于流中
  DMA_InitStructure.DMA_Channel = RHEOSTAT_ADC_DMA_CHANNEL; 
  //初始化DMA流，流相当于一个大的管道，管道里面有很多通道
	DMA_Init(RHEOSTAT_ADC_DMA_STREAM, &DMA_InitStructure);
	

	DMA_ITConfig(DMA2_Stream0,DMA_IT_TC,ENABLE);							//DMA?????????
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
	NVIC_InitStructure.NVIC_IRQChannel = DMA2_Stream0_IRQn;				//???????€????????????
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;				//???????? 
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;						//??????0 
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;							//????????????
	NVIC_Init(&NVIC_InitStructure);  	  									//???NVIC_InitStruct?????????????????VIC?????
	
	
	// 使能DMA流
  DMA_Cmd(RHEOSTAT_ADC_DMA_STREAM, ENABLE);             //
	
	// 开启ADC时钟
	RCC_APB2PeriphClockCmd(RHEOSTAT_ADC_CLK , ENABLE);
  // -------------------ADC Common 结构体 参数 初始化------------------------
	// 独立ADC模式
  ADC_CommonInitStructure.ADC_Mode = ADC_Mode_Independent;
  // 时钟为fpclk x分频	
  ADC_CommonInitStructure.ADC_Prescaler = ADC_Prescaler_Div4;       //      15Mhz
  // 禁止DMA直接访问模式	
  ADC_CommonInitStructure.ADC_DMAAccessMode = ADC_DMAAccessMode_Disabled;
  // 采样时间间隔	 
  ADC_CommonInitStructure.ADC_TwoSamplingDelay = ADC_TwoSamplingDelay_5Cycles;    //5
  ADC_CommonInit(&ADC_CommonInitStructure);
	
  // -------------------ADC Init 结构体 参数 初始化--------------------------
	ADC_StructInit(&ADC_InitStructure);
  // ADC 分辨率 
  ADC_InitStructure.ADC_Resolution = ADC_Resolution_12b;           
  // 扫描模式，多通道采集需要	
  ADC_InitStructure.ADC_ScanConvMode = ENABLE; 
  // 连续转换	
  ADC_InitStructure.ADC_ContinuousConvMode = ENABLE; 
  //禁止外部边沿触发
  ADC_InitStructure.ADC_ExternalTrigConvEdge = ADC_ExternalTrigConvEdge_None;
  //外部触发通道，本例子使用软件触发，此值随便赋值即可
  ADC_InitStructure.ADC_ExternalTrigConv = ADC_ExternalTrigConv_T1_CC1;
  //数据右对齐	
  ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right;
  //转换通道 1个
  ADC_InitStructure.ADC_NbrOfConversion = 2;                                    
  ADC_Init(RHEOSTAT_ADC, &ADC_InitStructure);
  //---------------------------------------------------------------------------
	
  // 配置 ADC 通道转换顺序和采样时间周期
  ADC_RegularChannelConfig(RHEOSTAT_ADC, RHEOSTAT_ADC_CHANNEL1, 1, 
	                         ADC_SampleTime_56Cycles);                                //480 - 20k
	ADC_RegularChannelConfig(RHEOSTAT_ADC, RHEOSTAT_ADC_CHANNEL2, 2, 
													 ADC_SampleTime_56Cycles);
//  ADC_RegularChannelConfig(ADC3, RHEOSTAT_ADC_CHANNEL3, 1, 
//	                         ADC_SampleTime_15Cycles); 
//	ADC_RegularChannelConfig(RHEOSTAT_ADC, RHEOSTAT_ADC_CHANNEL4, 4, 
//	                         ADC_SampleTime_3Cycles); 
//	ADC_RegularChannelConfig(RHEOSTAT_ADC, RHEOSTAT_ADC_CHANNEL5, 5, 
//	                         ADC_SampleTime_3Cycles); 
//	ADC_RegularChannelConfig(RHEOSTAT_ADC, RHEOSTAT_ADC_CHANNEL6, 6, 
//	                         ADC_SampleTime_3Cycles); 

  // 使能DMA请求 after last transfer (Single-ADC mode)
  ADC_DMARequestAfterLastTransferCmd(RHEOSTAT_ADC, ENABLE);
	
//	ADC_MultiModeDMARequestAfterLastTransferCmd(ENABLE);
  // 使能ADC DMA
  ADC_DMACmd(RHEOSTAT_ADC, ENABLE);
	
	// 使能ADC
  ADC_Cmd(RHEOSTAT_ADC, ENABLE);   
  //开始adc转换，软件触发
  ADC_SoftwareStartConv(RHEOSTAT_ADC);
}



void Rheostat_Init(void)
{
	Rheostat_ADC_GPIO_Config();
	Rheostat_ADC_Mode_Config();
}


float Get_Channelx_V(uint16_t x)
{
	float ADC_V;
	
	ADC_V = (float)ADC_ConvertedValue[x-10]/4096*(float)3.3;
	
	return ADC_V;
}



void DMA2_Stream0_IRQHandler(void)
{
	uint16_t i,err;
	float read;
	double max;
	char str[50];

	
	DMA_Cmd(RHEOSTAT_ADC_DMA_STREAM, DISABLE);
//	ADC_MultiModeDMARequestAfterLastTransferCmd(DISABLE);
  ADC_Cmd(RHEOSTAT_ADC, DISABLE);        
//	ADC_Cmd(ADC2, DISABLE);       
	DMA_ClearITPendingBit(RHEOSTAT_ADC_DMA_STREAM,DMA_IT_TCIF0); 
//	ADC_Cmd(ADC3, DISABLE);        
	for (i=0; i<1024; i++)  {
		ADC1_TURE[i] = (float)ADC_ConvertedValue[2*i]/4096*(float)3.3;
		ADC2_TURE[i] = (float)ADC_ConvertedValue[2*i+1]/4096*(float)3.3;
	}
	
	myfilter(101,1,b,1024,ADC1_TURE,ADC1_OUT);
	myfilter(101,1,b,1024,ADC2_TURE,ADC2_OUT);
	
	
	Get_Delta(ADC1_OUT,ADC2_OUT);
//	

	ADC_Cmd(RHEOSTAT_ADC, ENABLE);                       
	DMA_Cmd(RHEOSTAT_ADC_DMA_STREAM, ENABLE);
	ADC_SoftwareStartConv(RHEOSTAT_ADC);
	
	
	
//	DMA_Cmd(RHEOSTAT_ADC_DMA_STREAM, ENABLE);
}


